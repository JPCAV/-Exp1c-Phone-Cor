<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <!--External link for CSS style sheet-->
    <!--Line below for external CSS style sheet (when all files stored in same folder) when running file in browser i.e. offline
    <link href="style.css" rel="stylesheet" type="text/css">-->

    <!--Line below (i.e. ABSOLUTE path) for external CSS style sheet when running file online i.e. psych-JATOS-->
    <link rel="stylesheet" type="text/css" href="/study_assets/online/style.css"/>

    <!--This script is for running experiment on JATOS-->
    <script src="/assets/javascripts/jatos.js"></script>

    <!-- Use below ABSOLUTE path refs when running study on https://psych-jatos.newcastle.edu.au/jatos 
         (i.e. < JATOS Version 3.2.3)-->
    <script src="/study_assets/online/jquery1.js"></script>
    <script src="/study_assets/online/jquery2.js"></script>
    <script src="/study_assets/online/underscore.js"></script>

   <!-- <script src="jquery1.js"></script>
    <script src="jquery2.js"></script>
    <script src="underscore.js"></script> -->

</head>
<body>
  
  <div id ="preTrialGoFast"style="display: none;">
    <p> </p>
  <p> BE FAST!! </p>
  </div>

  <div id ="goFast"style="display: none;">
    <p> </p>
  <p> BE FAST!! </p>
  </div>

  <div id ="preTrialGoSlow"style="display: none;">
    <p> </p>
    <p> BE CAREFUL!! </p>
    </div>

  <div id ="goSlow"style="display: none;">
  <p> </p>
  <p> BE CAREFUL!! </p>
  </div>

<div id="inTime"style="display:none">
  <p> </p>
  <p> IN TIME! </p>
  <p> </p>
</div>

  <!--<div id ="countdown" style="display: none;">
  <p> You have <b id="timeLeft"> XXXX </b> seconds remaining </p>
  </div>-->

  <div>
      <table id="phoneTable">
          <tbody id="tableBody">
          </tbody>
      </table>
  </div>

<div id ="instructionsOne" style="display: none;">
  <p> Thankyou for participating in this study! </p>
  <p> <b>Please ensure that your browser is full screen.</b> </p>
	<p> In this study you will be shown selections of mobile phones. Each phone will have five different features. </p>
	<p> For each selection of phones, we ask you to select the phone you most prefer from the available options. </p>
	<p> There are no correct or incorrect answers. Our main interest is that you decide which phone you most prefer. </p>
	<p> In each trial you will be presented with a display similar to the one below. </p>
	<img src="/study_assets/online/phoneDCE.svg" alt="Phone Choice" >
	<p> It is your job to select the phone you prefer most by clicking the 'This one' button.  You will be asked to make <b id='howManyTrials'>XXXX</b> choices in total. </p>
	<p> This study will take approximately 45 minutes to complete. SONA points will be allocated after the experiment. </p>
</div>

<div id ="experimentEnd"style="display: none;">
    <p> You have now finished the experiment. Thank you for your participation! </p>
    <p> Your SONA points will be allocated shortly. </p>
</div>

<div id ="loading">
    <p>  </p>
</div>

<div id ="fixationCross" style="display: none;">
    <p> + </p>
</div>

<div id ="tooFast" class="timeout" style="display: none;">
    <p> <em> Too Fast!! </em></p>
    
</div>

<div id ="pleaseConsider" class="demand" style="display: none;">
  <p> Please avoid making your decision before you see the options. </p>
</div>

<div id ="tooSlow" class="timeout" style="display: none;">
    <p><em> Too slow!! </em> </p>
</div>

<div id ="makeFasterChoices" class="demand" style="display: none;">
  <p> It is important to carefully consider the available options. However, please try to make faster choices in future trials. </p>
</div>

<div id ="spacebarToContinue" style="display: none;">Press spacebar to continue</div>

<div id ="endBlock" style="display: none;">
    <p> End of Block. </p>
    <p> Please take a short break before continuing.</p>
    <p> Remember, your choices relate to purchasing </p>
    <p><b id="chosenProduct"></b></p>
    <p> Press spacebar to continue. </p>
</div>

<div id ="progress" style="display: none;">
    <p> You are up to choice <b id="currentProgress"> XXXX </b> / <b id="totalProgress"> XXXX </b> choices </p>
</div>

<script type="text/javascript">

// ----- Customisation -----
let correlatedPhones = true                            // IV1 - Set phone attributes to correlated (true) or uncorrelated (false)
const numAttributes = 5  	 			     			  	 		       // Number of Attributes/Attributes for each poduct
const randomPhonesMode = 2 				   				 		         /* Number of Options in a trial
                                                                    Modes: 
                                                                    0 = Choose a random phone from 'specificNumPhones' randomised per trial 
                                                                    1 = Random Phones between 'minPhones' & 'maxPhones'
                                                                    2 = static Phones from 'fixedPhones'
                                                                    3 = Static Phones from 'fixedPhones' randomised per block
                                                                    4 = static Phones, randomised BS. */
const randomPresentation = 1 									           /* Attribute order (vertically: top-btm) for DCE
                                                                    Modes: 
                                                                    0 = set order of Phones 
                                                                    1 = between subjects randomisation of order 
                                                                    2 = within subjects randomisation (per trial) */
const minPhones = 2                         				 		    // 'randomPhonesMode' = 1, min Phones to choose from
const maxPhones = 2                         				 		    // 'randomPhonesMode' = 1, max Phones to choose from
const fixedPhones = 3                      				 		    // 'randomPhonesMode' = 2, always have 'fixedPhones' number of Phones
const specificNumPhones = ["2", "4", "8"] 						      // Specific number of phones to be randomly chosen from
const BSPhones = ["2", "4", "8"]									          // Random no. phone options for BS design
const trialInstructions = true									              // SAT verbal instruction: false to turn off fast or accurate
const progressOn = false											                // Show participant progress (i.e. trials completed)
const randomTimer = false 										                // SAT countdown timer - Randomise duration for each trial
const timerPresent = false										                // SAT countdown timer - true = show timer, false = no timer
const tooSlowPresent = true										              // Timeout choices
const fastOrAccurate = [1,2] 									              // SAT Manipulation - Fast = 1, Accuratate = 2 
const nTrials = 25 // Old phone DCE - 25 trials              // Number of trials per block
const nBlocks = 10	// Old phone DCE - 6 blocks               // Number of blocks in experiment
const waitTime = 2000											                  // Time participant must wait, after a 'too fast' response, before they can continue
var maxTrialTime = []											                  // Maximum trial time - The length of time a stimulus is shown for
const setMaxTrialTime = 40000									                // Set maximum trial time (used if randomtimer = false)
const minTrialTime = 1000											                // Minimum trial time
const stimTime = 1000											                  // Stimulus duration of SAT instructions (when trialInstructions = true)
const postSelectTime = 500										                // Time after phone selected
var fixationTime = []											                  // Duration fixation cross is shown for
const minfixationtime = 1000										              // Minimum time of fixation cross presentation
const maxfixationtime = 4000   									            // Longest possible inter-trial time
const exponentialRate = .002                                 /* Rate parameter for exponentially distributed inter-trial times. 
                                                                 Rate = .002 -> mean exponential of 500ms. 
                                                                 combined with minfixationtime = 500 gives mean inter-trial time of 1 second. 
                                                                 set maxfixationtime to something sensible (eg 5 seconds)*/
// ---------------------------------------------------------------------------
const phoneBrands = ["A", "B", "C"] // Array of options/brands of phones
var attributes = [ // Available phone features and the random values it can have              
  ["Resolution", "1280 x 720", "1280 x 720", "1280 x 720", "1920 x 1080", "1560 x 720", "1520 x 720", "1440 x 720", "1520 x 720", "1520 x 720", "1544 x 720",
  "1920 x 1080", "1520 x 720", "1560 x 720", "1520 x 720", "2160 x 1080", "1520 x 720", "1520 x 720", "2560 x 1440", "1544 x 720", "1920 x 1080",
  "1520 x 720", "1600 x 720", "1920 x 1080", "2340 x 1080", "1920 x 1080", "1920 x 1080", "2340 x 1080", "2340 x 1080", "2280 x 1080", "2520 x 1080",
  "2312 x 1080", "1920 x 1080", "2340 x 1080", "1560 x 720", "1920 x 1080", "2560 x 1440", "2340 x 1080", "2280 x 1080", "1334 x 750", "2340 x 1080",
  "2340 x 1080", "2280 x 1080", "2560 x 1440", "2560 x 1440", "3840 x 2160", "2880 x 1440", "2280 x 1080", "2220 x 1080", "1334 x 750", "2340 x 1080",
  "2340 x 1080", "2340 x 1080", "2340 x 1080", "2400 x 1080", "2220 x 1080", "2880 x 1440", "2340 x 1080", "2340 x 1080", "3120 x 1400", "1280 x 720",
  "1334 x 750", "2960 x 1440", "1920 x 1080", "1620 x 1080", "1334 x 750", "2160 x 1080", "2340 x 1080", "2960 x 1400", "2960 x 1440", "2436 x 1125",
  "2280 x 1080", "2400 x 1080", "2960 x 1440", "2960 x 1440", "2280 x 1080", "1792 x 868", "1792 x 868", "2436 x 1125", "1792 x 828", "3040 x 1440",
  "2340 x 1080", "2280 x 1080", "3040 x 1440", "2688 x 1242", "1792 x 828", "3040 x 1440", "2436 x 1125", "2688 x 1242", "3040 x 1440", "1792 x 828",
   "3040 x 1440", "3040 x 1440", "3040 x 1440", "2436 x 1125", "2688 x 1242", "2436 x 1125", "3040 x 1440", "2688 x 1242", "2436 x 1125", "2688 x 1242",
  ],
  ['Screen Size', '5"', '5"', '5"', '5.2"', '6.1"', '5.7"', '5.5"', '6.2"', '6.2"', '6.4"',
  '5.5"', '6.3"', '6.4"', '6.2"', '5.5"', '6.2"', '5.7"', '5.7"', '6.4"', '5.5"',
  '6.3"', '6.5"', '5.2"', '6.6"', '6.4"', '5.7"', '6.5"', '6.3"', '6.3"', '6.3"',
  '6.2"', '5.2"', '6.4"', '6.1"', '5.0"', '5.1"', '6.4"', '5.8"', '4.7"', '6.4"',
  '5.5"', '6.2"', '5.5"', '5.5"', '5.5"', '5.7"', '6.3"', '5.6"', '4.7"', '6.5"',
  '6.3"', '6.4"', '6.4"', '6.7"', '5.6"', '6.0"', '6.4"', '6.4"', '6.4"', '3.3"',
  '4.7"', '6.2"', '5.5"', '4.5"', '4.7"', '5.5"', '6.1"', '5.8"', '6.3"', '5.8"',
  '5.8"', '6.7"', '6.2"', '6.3"', '5.7"', '6.1"', '6.1"', '5.8"', '6.1"', '6.4"',
  '6.5"', '5.7"', '6.1"', '6.5"', '6.1"', '6.3"', '5.8"', '6.5"', '6.3"', '6.1"',
  '6.4"', '6.8"', '6.4"', '5.8"', '6.5"', '5.8"', '6.8"', '6.5"', '5.8"', '6.5"',
  ],
  [ "Memory", "8GB", "16GB", "8GB", "32GB", "64GB", "16GB", "32GB", "32GB", "64GB", "64GB",
    "32GB", "32GB", "32GB", "64GB", "32GB", "64GB", "32GB", "64GB", "128GB", "32GB", 
    "64GB", "64GB", "32GB", "128GB", "32GB", "32GB", "128GB", "128GB", "64GB", "128GB", 
    "128GB", "32GB", "128GB", "128GB", "128GB", "32GB", "128GB", "32GB", "32GB", "64GB", 
    "128GB", "64GB", "128GB", "128GB", "32GB", "64GB", "128GB", "32GB", "128GB", "128GB", 
    "128GB", "128GB", "128GB", "128GB", "64GB", "128GB", "128GB", "256GB", "128GB", "32GB", 
    "64GB", "64GB", "128GB", "32GB", "128GB", "128GB", "128GB", "256GB", "64GB", "64GB", 
    "128GB", "128GB", "256GB", "128GB", "64GB", "64GB", "128GB", "256GB", "64GB", "128GB", 
    "256GB", "128GB", "512GB", "64GB", "128GB", "64GB", "512GB", "256GB", "128GB", "256GB", 
    "512GB", "256GB", "1000GB", "64GB", "64GB", "256GB", "512GB", "256GB", "512GB", "512GB",
    ],
    ["Camera", "5MP", "13MP", "8MP", "16MP", "13MP", "13MP", "13MP", "13MP", "13MP", "13MP", 
  "13MP", "13MP", "13MP", "13MP", "13MP", "13MP", "13MP", "12MP", "13MP", "16MP", 
  "16MP", "16MP", "12MP", "16MP", "16MP", "16MP", "48MP", "16MP", "16MP", "48MP", 
  "24MP", "12MP", "16MP", "48MP", "12MP", "16MP", "48MP", "12MP", "12MP", "25MP", 
  "48MP", "12MP", "20MP", "12MP", "23MP", "13MP", "48MP", "16MP", "12MP", "48MP", 
  "48MP", "48MP", "20MP", "32MP", "12MP", "12MP", "12MP", "20MP", "12MP", "12MP", 
  "12MP", "12MP", "12MP", "13MP", "12MP", "12MP", "40MP", "12MP", "12MP", "12MP", 
  "16MP", "48MP", "12MP", "12MP", "16MP", "12MP", "12MP", "12MP", "12MP", "16MP", 
  "40MP", "16MP", "16MP", "12MP", "12MP", "16MP", "12MP", "12MP", "16MP", "12MP", 
  "16MP", "12MP", "16MP", "12MP", "12MP", "12MP", "12MP", "12MP", "12MP", "12MP",
  ], 
  ["Price", "$44", "$134", "$179", "$179", "$199", "$199", "$199", "$229", "$239", "$249",
  "$249", "$249", "$279", "$279", "$279", "$299", "$299", "$299", "$299", "$299",
  "$299", "$299", "$299", "$349", "$379", "$379", "$399", "$399", "$399", "$399",
  "$399", "$399", "$399", "$399", "$399", "$399", "$449", "$449", "$499", "$499",
  "$499", "$499", "$499", "$499", "$499", "$499", "$549", "$549", "$599", "$599",
  "$599", "$599", "$599", "$649", "$649", "$699", "$699", "$699", "$699", "$699",
  "$779", "$799", "$799", "$799", "$859", "$879", "$899", "$899", "$899", "$999", 
  "$999", "$999", "$999", "$999", "$1049", "$1049", "$1129", "$1149", "$1199", "$1199", 
  "$1199", "$1199", "$1199", "$1249", "$1279", "$1279", "$1349", "$1399", "$1429","$1449",
  "$1599","$1699","$1699","$1749","$1899","$1999","$1999","$2149","$2349","$2499",
  ],];

var startDate
var startTime
var endDate
var endTime
var countdownEndTime
var currenttotaltrial
var rt
var nCurrentTrial
var nCurrentBlock = 0
var experimentStartDate
var experimentStartTime
var currentDate
var currentTime
var experimentTotalTime
var totaltrials = (nTrials*nBlocks)
var phoneArray = []
var usingAttributes = []
var numPhones = []
var dataOutput = []
var randomStimulus
var stimulus
// ------------- Variables created for RS Experiment --------------
var username // = $("#username") uncomment this var to assign a Sona ID to username WHEN using dialog prompt box below
var stopContEvent = false
var regEOBKP = false
//-- timeout variables --//
var contWaitTime
var instructDelay1
var timeout
var stimTimeout
var fixationTimeout
var postTimeout
var pFeedbackTO
var endExpTO
var dceTimeout
//------------------------//
var dialogBox = $('#dialog-box')
var fullscreen = $('#fullscreen')
var taskDiv = $('#task-div')
var instruxOne = $('#instructionsOne')
var loading = $('#loading')
var countdownDiv = $('#countdown')
var progressDiv = $('#progress')
var endBlock = $('#endBlock')
var goFast = $('#goFast')
var goSlow = $('#goSlow')
var preTrialGoFast = $('#preTrialGoFast')
var preTrialGoSlow = $('#preTrialGoSlow')
var fixationCross = $('#fixationCross')
var expEnd = $("#experimentEnd")
var spacebarToContinue = $('#spacebarToContinue')
var tooSlowDiv = $("#tooSlow")
var pleaseConsider = $("#pleaseConsider")
var fasterChoicesDiv = $("#makeFasterChoices")
var tooFastDiv = $("#tooFast")
var inTimeDiv = $("#inTime")

// The below "jatos.onload(function grabSonaID()" function is required when running ONLINE psych-JATOS study
jatos.onLoad(function grabSonaID() {
       //var username = jatos.studySessionData.username
     if (jatos.urlQueryParameters.hasOwnProperty("id")) {
               //var username = "0"
               username = jatos.urlQueryParameters.id
               //console.log("a:" + username)
               jatos.studySessionData["SonaID"] = username
             } else {
           username = null
           jatos.studySessionData["SonaID"] = username
           }
     instructOne()
   })

function instructOne() {
  correlatedPhones = (Math.random() < 0.5 ? true: false);
  console.log('Phones attributes correlated ' + correlatedPhones)
  instruxOne.show()
	experimentStartDate = new Date()
	experimentStartTime = experimentStartDate.getTime()
  instructDelay1 = setTimeout(instructOneButton, 1000)
  document.getElementById('howManyTrials').innerHTML = totaltrials
}

function instructOneButton (){
  // 1. Create the button
  var introButton = document.createElement("button")
  introButton.innerHTML = "Click here to continue"
  // 2. Append somewhere
  document.getElementById('instructionsOne')
  instructionsOne.appendChild(introButton)
  // 3. Add onclick
  introButton.setAttribute("class", "btn")
  introButton.setAttribute("onclick", "postInstruct()")
}

function postInstruct() {
  instruxOne.hide()
  initialiseSetup()
  initialisePhonesSetup()
}

function initialiseSetup() { // Begin experiment - display phoneTable/DCE
  document.getElementById("phoneTable").style.display = "block"
  document.getElementById("totalProgress").innerHTML = totaltrials
}

function initialisePhonesSetup() { //This function generates the NUMBER of attributes to be used when creating DCE
  //console.log("initialisePhonesSetup")
  nCurrentTrial = 0
  var randomSelectedPhone = Math.floor(Math.random() * specificNumPhones.length)
      blockPhones = specificNumPhones[randomSelectedProduct] 
      // Pick a random number - number informs how many options/phones shown in each trial - set  at the start of each block i.e. nCurrentTrial = 0
    if (nCurrentBlock == 0) { // Only on first block 
      for (var i = 0; i < attributes.length; i++) // For the number of attributes in an option
        usingAttributes.push(i) // Fill usingAttributes array - gives attribute order for the DCE. i.e. in numeric order 0,1,2,3,4
	    if (randomPhonesMode == 4) { 
	        var randomSelectedProduct = Math.floor(Math.random() * BSPhones.length)
              BSnumPhones = BSPhones[randomSelectedProduct] 
            } // randomPhonesMode == 4 Generate random number - determines  no. options/phones to be shown for entire experiment
        else {
          }
          if (randomPresentation == 1) { // Randomise the order of attributes displayed in DCE b/w subjects (shuffle usingAttributes array)
            for (var i = 0; i < usingAttributes.length; i++) { // For no. of attributes
                 var randomFeature = Math.floor(Math.random() * usingAttributes.length) // Generate random number
                 var temp = usingAttributes[i] // temp = index i of usingAttributes array
                 usingAttributes[i] = usingAttributes[randomFeature] // Set index i of usingAttributes array to no. at index of 'randomFeature' no.
                 usingAttributes[randomFeature] = temp 
              }
            } else {
            }
      postTrial()
	}
 else {
 postTrial()
 }
}

function postTrial() {
  //console.log("postTrial")
  loading.show()
  document.getElementById("phoneTable").style.display = "none"
  document.getElementById("totalProgress").innerHTML = totaltrials
  //progDiv()
	if (trialInstructions == false) {
    postTimeout = setTimeout(preTrial, postSelectTime)
  }
  else if (trialInstructions == true) {
    postTimeout = setTimeout(trialSATCue, postSelectTime)
  } else {
  }
}

/*function progDiv() {
  if (progressOn == true) {
    progressDiv.show()
  }
else {
  progressDiv.hide()
  }
}*/

function preTrial() {
  //console.log("preTrial")
  clearTimeout(postTimeout)
  goSlow.hide()
  goFast.hide()
  preTrialGoFast.hide()
  preTrialGoSlow.hide()
  loading.hide()
  fixationCross.show()
  document.getElementById("phoneTable").style.display = "none"
  document.getElementById("totalProgress").innerHTML = totaltrials
  //progDiv()
  /* Exponential random number generator i.e. Time until next DCE stimulus appears 
  Taken from truncated exponential distribution for ITI times. 
  Repeatedly sample fixationTime until the random ITI is less than maxFixationTime*/
	fixationTime = 20000  // set to large value prior to sampling inter-trial time
	while(fixationTime > maxfixationtime) {
         fixationTime = randomExponential(exponentialRate)
      }
      if (trialInstructions == false) {
        fixationTimeout = setTimeout(trialSATCue, fixationTime)
      } else if (trialInstructions == true) {
        fixationTimeout = setTimeout(generateProductArray, fixationTime)
      } else { 
      }
    }

function randomExponential(rate, randomUniform) {
  //console.log("randomExponential")
  //Allow to pass a random uniform value or function. Default to Math.random()
  var U = randomUniform
  if (typeof randomUniform === 'function') U = randomUniform()
  if (!U) U = Math.random()
  return (-Math.log(U)/rate) + minfixationtime
}

function trialSATCue() {
  //console.log("trialSATCue")
  clearTimeout(postTimeout)
  clearTimeout(fixationTimeout)
  loading.hide()
  fixationCross.hide()
if (randomPresentation == 2) { // 2 = Randomise the position of attributes in the DCE on each trial
 for (var i = 0; i < usingAttributes.length; i++) {
        var randomFeature = Math.floor(Math.random() * usingAttributes.length)
        var temp = usingAttributes[i]
        usingAttributes[i] = usingAttributes[randomFeature]
        usingAttributes[randomFeature] = temp
      }
    } else {
    }
if (trialInstructions == true) { // true = SAT instructions present
  var randomStimulus = Math.floor(Math.random() * fastOrAccurate.length) // Generate random number b/w 1-2
            stimulus = fastOrAccurate[randomStimulus] // Set stimulus to "GO FAST" or "BE CAREFUL"
            if (stimulus == 1) { // GO FAST
              preTrialGoFast.show()
              document.getElementById("phoneTable").style.display = "none"
              stimTimeout = setTimeout(preTrial, stimTime)
              if (randomTimer == true) { // Uncomment here +4 lines for countdown timer
                temp = Math.floor(Math.random() * maxTrialTimeOpt.length)
                maxTrialTime = maxTrialTimeOpt[temp]
                maxTrialTime = durations.shift()
              } else {
		maxTrialTime = setMaxTrialTime
		}
	}
else if (stimulus == 2) {
  preTrialGoSlow.show() // BE CAREFUL
  document.getElementById("phoneTable").style.display = "none"
  stimTimeout = setTimeout(preTrial, stimTime)
  if (randomTimer == true) {
		 temp = Math.floor(Math.random() * maxTrialTimeOpt.length)
     maxTrialTime = maxTrialTimeOpt[temp]
      } else {
		maxTrialTime = setMaxTrialTime
		}
	} else {
}
} else {
(stimulus == 0) // Use timer SAT manipulation
if (randomTimer == true) {
		 temp = Math.floor(Math.random() * maxTrialTimeOpt.length)
     maxTrialTime = maxTrialTimeOpt[temp]
  } else {
		maxTrialTime = setMaxTrialTime
		}
generateProductArray()
  }
}

function generateProductArray() {									//makes the array of Phones
  //console.log("generateProductArray")
  document.getElementById("phoneTable").style.display = "block"
  fixationCross.hide()
  //progDiv()
  clearTimeout(fixationTimeout)
   switch(randomPhonesMode) { 
     // This function determines the number of options to be shown in the DCE, case by case
        case 0: // 0 = Choose a random number from 'specificNumPhones' i.e. 2, 4, or 8 phones
            var randomSelectedProduct = Math.floor(Math.random() * specificNumPhones.length)
            numPhones = specificNumPhones[randomSelectedProduct] 
            break
        case 1: // 1 = Choose a random number between 'minPhones' & 'maxPhones'. number = number of phone options per trial
            numPhones = Math.floor(Math.random() * (maxPhones - minPhones + 1) + minPhones)
            break
        case 2: // 2 = Hard code number of phones to be shown per trial. Number taken from var fixedPhones = X
            numPhones = fixedPhones
            break
        case 3: // 3 = Select random number of options/phones to be shown for a block e.g. Block 1 = 2, block 4 = 8 etc..
        	numPhones = blockPhones
        	break
        case 4: // 4 = Select random number of options/phones to be shown for entire experiment
        	numPhones = BSnumPhones
          break
        }
    phoneArray = []
    // Create 'numPhones' new phones - this is determined by the numbers from 1 of the 4 cases above
    for (var i = 0; i < numPhones; i++) {
        new_phone = createNewProduct(correlatedPhones)
        if(phoneArray.some(phone => _.isEqual(phone, new_phone))){
          i--
          //console.log('duplicate option')
          continue
        }
        //console.log('unique option')
        phoneArray.push(new_phone)// Phones are created by createNewProduct func, run  for 'numPhones' times
      }
      updateTable()
      updateTrialNumber()
      //timeLeft()
    }

function createNewProduct(correlated) {	//creates Phones
    //console.log("createNewProduct")
    // Initialise product
    var phone = {attributes:[]}
    if(correlated) {
      var randomValue = Math.floor(Math.random() * (attributes[0].length - 1)) + 1
      //console.log('correlated ' + randomValue)
    }
    // Add the attributes
    for (var i = 0; i < numAttributes; i++) {
        // Pick a random attribute from usingAttributes
        if(!correlated) {
        var randomValue = Math.floor(Math.random() * (attributes[usingAttributes[i]].length - 1)) + 1
       // console.log('Uncorrelated ' + randomValue)
        //console.log(phone)
      }
        phone.attributes[usingAttributes[i]] = attributes[usingAttributes[i]][randomValue]
        //console.log(phone)
      }
    // Return the new product
    return phone
  }


function updateTable() { // Create the phone table DCE
    //console.log("updateTable()")
    
    // Get the child nodes of the table
    var tableBody = document.getElementById("tableBody")
    var tableRows = tableBody.getElementsByTagName("tr")

    // Delete the current table
    while(tableRows.length != 0)
        tableRows[0].remove()

    // Add the Brand column - column name for first column (attributes)
    var row = createRow()
    addCell(row, "th", "")

    /*// Add the current attributes row
    for (var brand = 0; brand < numPhones; brand++) {
        addCell(row, "td", phoneBrands[brand])
    }*/

    // Fill the data in
    for (var currentFeature = 0; currentFeature < numAttributes; currentFeature++) {
        var row = createRow()

        for (var currentPhone = -1; currentPhone < numPhones; currentPhone++) {
            if (currentPhone == -1) // Add attribute names e.g. Price, memory to beginning of each row
                addCell(row, "th", attributes[usingAttributes[currentFeature]][0])
            else // Add attribute levels to cells e.g. $xx, xxGB, xxMP, xx"
                addCell(row, "td", phoneArray[currentPhone].attributes[usingAttributes[currentFeature]])
        }
    }

    // Add the Select row
    var row = createRow()
    addCell(row, "th", "Select")

    // Add the current attributes columns
    for (var currentPhone = 0; currentPhone < numPhones; currentPhone++) {
        // Select button
        var selectPhone = document.createElement("td")
        var selectPhoneButton = document.createElement("button")
        selectPhoneButton.innerHTML = "This one"
        selectPhone.appendChild(selectPhoneButton)
        selectPhoneButton.setAttribute("class", "btn")
        selectPhoneButton.setAttribute("onclick", "stopTimer(); phoneSelected(" + currentPhone + "); ")
        row.appendChild(selectPhone)
    }
    /*if (timerPresent == true) {
	document.getElementById("countDown").style.display = "block"
	}
	else {
	}*/
  
	if (trialInstructions == true){
    	if (stimulus == 1) {
      preTrialGoFast.hide()
      goFast.show()
    	} else if (stimulus == 2) {
        goSlow.show()
        preTrialGoSlow.hide()
		} else {
    }
}
else {
}
	document.getElementById("phoneTable").setAttribute("style", "align:center;")
  startTimer()
  if (tooSlowPresent == true) {
    timeout = setTimeout(tooSlow, maxTrialTime)
    } else {
    }
}

function updateTrialNumber() {
  //console.log("updateTrialNumber")
  currenttotaltrial = ((nCurrentTrial + 1) + (nCurrentBlock * nTrials))
  document.getElementById("currentProgress").innerHTML = currenttotaltrial
}

function createRow() {
  //console.log('createRow')
    var row = document.createElement("tr")
    tableBody.appendChild(row)
    return row
}

function addCell(row, type, input) {
  //console.log('addCell')
    var cell = document.createElement(type)
    cell.innerHTML = input
    row.appendChild(cell)
    return cell
}

function phoneSelected(selected) { //records which product is selected and generates what happens next
    //console.log("phoneSelected")
    clearTimeout(timeout)
    //rt = endTime - startTime
    if (rt < minTrialTime) {
        var output = ""
    // Output file - "Too Fast!" trial
    for (var currentproduct = 0; currentproduct < numPhones; currentproduct++) {
        output += nCurrentBlock +", " + nCurrentTrial + ", " // Record Block # and trial #
            for (var currentFeature = 0; currentFeature < numAttributes; currentFeature++) { // Record attributes
                     output += phoneArray[currentproduct].attributes[usingAttributes[currentFeature]] + ", "
                    }
        output += rt + ", " // Record RT
        output += "fast" + ", " // Record trialError = fast
        if (tooSlowPresent == true) {
        output += maxTrialTime + ", " // Record the max trial duration
      } else {
        output += "null" + ", " // Record "null" on this trial
      }
        output += fixationTime + ", " // Record the fixation cross duration
         if (stimulus == 0)            // If no SAT verbal instructions i.e. countdown timer
        	output += "0, "                // Record 0
        else if (stimulus == 1)        // SAT verbal instruction
        	output += "1, "                // record trial type i.e. "1" or "GO FAST" trial
        else if (stimulus == 2)        // SAT verbal instruction
        	output += "2, "                // record trial type i.e. "2" or "BE CAREFUL" trial
        else
        	output += "0, "
        if (currentproduct == selected) // Record 1 if chose the current option
        output += "1, "
        else
        output += "0, "
        if(correlatedPhones == true)
        output += "correlated;\n"
        else
        output += "uncorrelated;\n"
      }
    dataOutput.push(output)
    //console.log("phoneSelected-tooFastTrial")
        tooFast()
        }
    else {
    var output = "" // Output file - VALID TRIAL
    // For each option, record:
    for (var currentproduct = 0; currentproduct < numPhones; currentproduct++) {
      output += nCurrentBlock +", " + nCurrentTrial + ", " // Record Block # and trial #
      for (var currentFeature = 0; currentFeature < numAttributes; currentFeature++) { // Record attributes
        output += phoneArray[currentproduct].attributes[usingAttributes[currentFeature]] + ", "
      } 
      output += rt + ", " // Record Rt
      output += "null" + ", " // trialError = "null" i.e. made a selection in time (!= too fast/too slow)
      if (tooSlowPresent == true) {
        output += maxTrialTime + ", "
      } 
      else {
        output += "null" + ", "
      }
      output += fixationTime + ", "  // Record the fixation cross duration
      if (stimulus == 0)              // If no SAT verbal instructions i.e. timer
      output += "0, "                   // Record condition = 0
      else if (stimulus == 1)         // SAT verbal instruction
      output += "1, "                   // record trial type i.e. "1" or "GO FAST" trial
      else if (stimulus == 2)         // SAT verbal instruction
      output += "2, "                   // record trial type i.e. "2" or "BE CAREFUL" trial
      else 
      output += "0, "
      if (currentproduct == selected) // Record "1" if chose the current option
      output += "1, "
      else
      output += "0, "
      if(correlatedPhones == true)
        output += "correlated;\n"
        else
        output += "uncorrelated;\n"                // Record "0" if DID NOT chose the current option
    }
    dataOutput.push(output)
    posiFeedback()
    //console.log("phoneSelected - Valid Trial")
  }
}

function posiFeedback() {
  inTimeDiv.show()
  goFast.hide()
  goSlow.hide()
  document.getElementById("phoneTable").style.display = "none"
  //console.log("Valid trial positive feedback")
  pFeedbackTO = setTimeout(nextRound, 500)
}

function startTimer() { //starts the timer
  //console.log("startTimer")												
    startDate = new Date()
    startTime = startDate.getTime()
    countdownEndTime = startTime + maxTrialTime
	}

/*
function timeLeft() {												//function that writes how long left
console.log("timeLeft")
      if (timerPresent == true) {
   		 if (tooSlowPresent == true) {
    		countdownEndTime = startTime + maxTrialTime
    		TimeRemaining = (countdownEndTime - new Date())/1000
    		if (TimeRemaining > 0) {
    			document.getElementById('timeLeft').innerHTML = Number(Math.round(TimeRemaining+'e0')+'e-0')
    			countdownTimeout = setTimeout (timeLeft, counter)
    		}
    		else {
    			document.getElementById('timeLeft').innerHTML = 0
    			countdownTimeout = setTimeout (timeLeft, counter)
   				 }
    		}
    		else {
    			document.getElementById('timeLeft').innerHTML = NA
    			countdownTimeout = setTimeout (timeLeft, counter)
    			}
    		}
    	else {
    	}
	}
*/

function stopTimer() {  // Stops the timer
  //console.log('stopTimer')												
    endDate = new Date()
    endTime = endDate.getTime()
    rt = endTime - startTime
    //inTrial = false
	}

function tooFast() { // 'TOO FAST' choices (can set MinTrialTime above)
  //console.log("tooFast")
  document.getElementById("phoneTable").style.display = "none"
  tooFastDiv.show()
  pleaseConsider.show()
  goSlow.hide()
  goFast.hide()
  //progDiv()
  nCurrentTrial++
  if (nCurrentTrial == nTrials) {
        endOfBlock()
        } else {
        contWaitTime = setTimeout(fastTimeout, waitTime)
        }
    }

function fastTimeout() {
  //console.log("fastTimeout")
  stopContEvent = true
  clearTimeout(contWaitTime)
  spacebarToContinue.show()
  document.addEventListener('keyup', contKP, false)
}

function contKP(event) { // Press spacerbar to continue key press function
  if (event.keyCode == 32 && stopContEvent == true){
    stopContEvent = false
    event.preventDefault()
    document.removeEventListener('keyup', contKP, false)
    spacebarToContinue.hide()
    tooSlowDiv.hide()
    fasterChoicesDiv.hide()
    tooFastDiv.hide()
    pleaseConsider.hide()
    postTrial()
    //console.log('spacebar Pressed')
  }
}

function tooSlow() {	// Choices when participant is too slow to respond
  //console.log("tooSlow")
  stopTimer()
  document.getElementById("phoneTable").style.display = "none"
  tooSlowDiv.show()
  fasterChoicesDiv.show()
  goFast.hide()
  goSlow.hide()
  // Output file - "TOO SLOW" trial
  var output = ""
  for (var currentproduct = 0; currentproduct < numPhones; currentproduct++) {
        output += nCurrentBlock +", " + nCurrentTrial + ", " // Record block # and trial #
       for (var currentFeature = 0; currentFeature < numAttributes; currentFeature++) { // Record attributes
           output += phoneArray[currentproduct].attributes[usingAttributes[currentFeature]] + ", "
          }
          output += rt + ", "          // Record RT
          output += "Slow" + ", "      // Record trialError = "SLOW"
          if (tooSlowPresent == true) {
            output += maxTrialTime + ", " // Record length of time the DCE was shown for
          }
          else {
            output += "null" + ", "       // Record null for maxTrialTime when not using a timer
          }
          output += fixationTime + ", "   // Record length of time fixation cross was shown
          if (stimulus == 0)               // If no SAT verbal instructions i.e. timer
          output += "0, "                     // condition = "0"
          else if (stimulus == 1)          // SAT verbal instruction
          output += "1, "                     // condition = "1" or "GO FAST" trial
          else if (stimulus == 2)          // SAT verbal instruction
          output += "2, "                     // condition = "2" or "BE CAREFUL" trial
          else
          output += "0, "
          output += "0, "
          if(correlatedPhones == true)
          output += "correlated;\n"
          else
          output += "uncorrelated;\n"
        }                                  // Record selected = "0" (no choice made)
    dataOutput.push(output)
    nCurrentTrial++
	 if (nCurrentTrial == nTrials) {
        endOfBlock()
        }
        else {
            contWaitTime = setTimeout(fastTimeout, waitTime)
            }
          }

function nextRound() { // moves to the next trial
    //console.log("nextRound")
    clearTimeout(pFeedbackTO)
    inTimeDiv.hide()
    nCurrentTrial++
    if (nCurrentTrial < nTrials) {
        postTrial()
        }
    else {
        endOfBlock()
        }
    }



function endOfBlock() {	//works out the end of the block
 	//console.log("endOfBlock")
  tooFastDiv.hide()
  pleaseConsider.hide()
  tooSlowDiv.hide()
  fasterChoicesDiv.hide()
  nCurrentTrial = (nCurrentTrial - nTrials)
 	nCurrentBlock++
 	 if (randomPhonesMode == 3) {
 	 var randomSelectedPhone = Math.floor(Math.random() * specificNumPhones.length)
    blockPhones = specificNumPhones[randomSelectedPhone]
    }
    else {
    }
 	if (nCurrentBlock < nBlocks) {
 		showEndBlock()
 		}
 	else {
 		endOfExperiment()
 	}
 }

function showEndBlock() {	//shows "end of block"
  //console.log("showEndBlock")
  regEOBKP = true
  endBlock.show()
  document.getElementById("phoneTable").style.display = "none"
  document.addEventListener('keyup', endOBContKP,false)
  //progDiv()
}

function endOBContKP(event) { // Event listener for end of block key press
  //console.log("endOBContKP")
  if (event.keyCode == 32 && regEOBKP == true){
    regEOBKP = false
    event.preventDefault()
    document.removeEventListener('keyup', endOBContKP, false)
    endBlock.hide()
    postTrial()
  }
}

function endOfExperiment() { //shows the experiment end
  //console.log("endOfExperiment")
  expEnd.show()
  document.getElementById("phoneTable").style.display = "none"
  console.log(dataOutput)
  endExpTO = setTimeout(saveResults, 2000)
}

function saveResults() { //function to save the output file to php
    console.log("saveResults")
    clearTimeout(endExpTO)
    /* Output file appearance
    Block, trial, feature 1, feature 2, feature n, reponse time, 
    was there an error? (0/1/2 - no error/too fast/too slow),selected this phone 1/0 (Y/N)
    */
    var output_txt = "block, " + "trial, " // Record block # and trial #
    for (i = 0; i < numAttributes; i++) // On each trial, for each attribute
    output_txt += "feature_" + i + ", " // Record attribute name
    output_txt += "rt, "                // Record response time
    output_txt += "Error, "             // Record if there was an error i.e. selection too fast/too slow or in time = NULL)
    output_txt += "MaxTrialTime, "      // Record length of time the DCE was shown for
    output_txt += "fixationTime, "      // Record length of time fixation cross was shown
    output_txt += "condition, "         // Record SAT condition 1 = "GO FAST" trial, 2 = "BE CAREFUL" trial
    output_txt += "selected, "          // Record the number of the chosen option
    output_txt += "attCorrelation\n"    // Record condition for attribute correlation
    for (var i = 0; i < dataOutput.length; i++) {
        output_txt += dataOutput[i].toString() + "\n"
    }
    console.log("check") 

    var expVarTxt = output_txt
    var expVarFn = username
    var expSendVariables = "" + expVarTxt + "SonaID=" + expVarFn

    //experimentDataRequest.send(expSendVariables)
    console.log(expSendVariables)

    //from:  http://help.dottoro.com/ljskourt.php
jatos.submitResultData(expSendVariables, pointsLink)
    ////console.log(experimentDataRequest.responseText)
    pointsLink()
}


/* SONA point credit options - Information found here https://psych.newcastle.edu.au/sona/researchers/SONA_external_credit.pdf

// The client-side completion URL will look like this:
    https://newcastle.sona-systems.com/webstudy_credit.aspx?experiment_id=123&credit_token=9185d436e5f94b1581b0918162f6d7e8&survey_code=XXXX
// The server-side completion URL will look like this (if displayed):
  https://newcastle.sona-systems.com/services/SonaAPI.svc/WebstudyCredit?experiment_id=123&credit_token=9185d436e5f94b1581b0918162f6d7e8&survey_code=XXXX
*/


function pointsLink() {
        var url = "https://newcastle.sona-systems.com/services/SonaAPI.svc/WebstudyCredit?experiment_id=1062&credit_token=c4eac5ef19974180ab814513d16d76ce&survey_code=" + username
        var xhttp = new XMLHttpRequest()
        xhttp.open("GET", url, true)
    xhttp.send()
    jatos.endStudyAjax(true)
  }



/*
function pointsLink() { // Original pointslink function
        setTimeout(function() {
        window.location.href = "https://newcastle.sona-systems.com/webstudy_credit.aspx?experiment_id=947&credit_token=d75b5797aa44475bac6c2e9753029335&survey_code=" + username
      }, 2000)

          jatos.endStudy()
       }
*/

</script>
</body>
</html>
